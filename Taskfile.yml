version: "3"

vars:
  VERSION:
    sh: grep '"version"' web/package.json | head -1 | sed 's/.*"version".*"\([^"]*\)".*/\1/'
  COMMIT:
    sh: git rev-parse --short HEAD 2>/dev/null || echo "unknown"
  BUILD_TIME:
    sh: date -u '+%Y-%m-%dT%H:%M:%SZ'
  LDFLAGS: -X github.com/Bowl42/maxx/internal/version.Version={{.VERSION}} -X github.com/Bowl42/maxx/internal/version.Commit={{.COMMIT}} -X github.com/Bowl42/maxx/internal/version.BuildTime={{.BUILD_TIME}}

tasks:
  dev:
    desc: Run full-stack development (backend + frontend)
    deps: [dev:backend, dev:frontend]

  dev:backend:
    desc: Run backend development server
    cmds:
      - go run cmd/maxx/main.go

  dev:frontend:
    desc: Run frontend development server
    dir: web
    cmds:
      - pnpm dev

  dev:desktop:
    desc: Run Wails desktop application in development mode
    cmds:
      - wails dev

  install:
    desc: Install all dependencies
    cmds:
      - task: install:frontend
      - task: install:wails

  install:frontend:
    desc: Install frontend dependencies
    dir: web
    cmds:
      - pnpm install

  install:wails:
    desc: Install Wails CLI
    cmds:
      - go install github.com/wailsapp/wails/v2/cmd/wails@latest

  build:
    desc: Build complete application (frontend + backend)
    cmds:
      - task: build:frontend
      - task: build:backend

  build:frontend:
    desc: Build frontend
    dir: web
    env:
      VITE_COMMIT: "{{.COMMIT}}"
    cmds:
      - pnpm build

  build:backend:
    desc: Build backend with version info
    cmds:
      - go build -ldflags '{{.LDFLAGS}}' -o maxx cmd/maxx/main.go

  clean:
    desc: Clean build artifacts
    cmds:
      - rm -f maxx
      - rm -rf web/dist

  version:
    desc: Show version info
    cmds:
      - 'echo "Version: {{.VERSION}}"'
      - 'echo "Commit:  {{.COMMIT}}"'
      - 'echo "Build:   {{.BUILD_TIME}}"'

  docker:
    desc: Build Docker image
    cmds:
      - docker build --build-arg VERSION={{.VERSION}} --build-arg COMMIT={{.COMMIT}} --build-arg BUILD_TIME={{.BUILD_TIME}} --build-arg VITE_COMMIT={{.COMMIT}} -t maxx .

  build:desktop:
    desc: Build Wails desktop application for current platform
    cmds:
      - wails build -ldflags '{{.LDFLAGS}}' -debug

  build:desktop:darwin:
    desc: Build Wails desktop application for macOS (both arm64 and amd64)
    cmds:
      - wails build -ldflags '{{.LDFLAGS}}' -platform darwin/arm64
      - wails build -ldflags '{{.LDFLAGS}}' -platform darwin/amd64

  build:desktop:windows:
    desc: Build Wails desktop application for Windows
    cmds:
      - wails build -ldflags '{{.LDFLAGS}}' -platform windows/amd64

  build:desktop:linux:
    desc: Build Wails desktop application for Linux
    cmds:
      - wails build -ldflags '{{.LDFLAGS}}' -platform linux/amd64

  build:desktop:all:
    desc: Build Wails desktop application for all platforms
    cmds:
      - task: build:desktop:darwin
      - task: build:desktop:windows
      - task: build:desktop:linux
